version: '3.8'

services:
  consumer-app:
    # 1. 내 프로젝트를 이미지로 빌드
    build: .
    container_name: only4_kafka_consumer

    # 2. 실행 후 자동으로 꺼지지 않게 설정
    restart: always

    # 3. 환경 변수 덮어쓰기 (가장 중요! ⭐)
    # application.yml에는 localhost로 되어있지만,
    # 배포/도커 실행 시에는 아래 값으로 바꿔치기합니다.
    environment:
      # [Kafka 주소 변경]
      # 로컬 도커 테스트 시: host.docker.internal:9092
      # 실제 배포 시(같은 네트워크): kafka:29092 또는 서버_사설IP:9092
      SPRING_KAFKA_BOOTSTRAP_SERVERS: host.docker.internal:9092

      # [DB 주소 변경]
      SPRING_DATASOURCE_URL: jdbc:postgresql://host.docker.internal:5432/${POSTGRES_DB}
      SPRING_DATASOURCE_USERNAME: ${POSTGRES_USER}
      SPRING_DATASOURCE_PASSWORD: ${POSTGRES_PASSWORD}

      # [프로파일 설정]
      # 배포 환경임을 알려주기 위해 prod로 설정하는 경우가 많음
      SPRING_PROFILES_ACTIVE: prod

    # 4. .env 파일 사용 명시
    env_file:
      - .env

    # 5. 리눅스/Mac 도커에서 호스트(주인님) 컴퓨터를 찾기 위한 설정
    extra_hosts:
      - "host.docker.internal:host-gateway"